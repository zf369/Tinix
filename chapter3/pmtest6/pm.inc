;----------------------------------------------------------------------------
; 描述符类型值说明
; 其中:
;       DA_  : Descriptor Attribute
;       D    : 数据段
;       C    : 代码段
;       S    : 系统段
;       R    : 只读
;       RW   : 读写
;       A    : 已访问
;       其它 : 可按照字面意思理解
;----------------------------------------------------------------------------
DA_32        EQU    4000h   ; 32位段
DA_LIMIT_4K	 EQU	8000h	; 段界限粒度为 4K 字节

DA_DPL0		 EQU	  00h	; DPL = 0
DA_DPL1		 EQU	  20h	; DPL = 1
DA_DPL2		 EQU	  40h	; DPL = 2
DA_DPL3		 EQU	  60h	; DPL = 3

;----------------------------------------------------------------------------
; 存储段描述符类型值说明
;----------------------------------------------------------------------------
DA_DR        EQU    90h     ; 存在的只读数据段
DA_DRW       EQU    92h     ; 存在的可读写数据段
DA_DRWA		 EQU	93h	    ; 存在的已访问可读写数据段

DA_C		 EQU	98h	    ; 存在的只执行代码段
DA_CR		 EQU	9Ah	    ; 存在的可执行可读代码段
DA_CCO		 EQU	9Ch	    ; 存在的只执行一致代码段
DA_CCOR		 EQU	9Eh	    ; 存在的可执行可读一致代码段

;----------------------------------------------------------------------------
; 系统段描述符类型值说明
;----------------------------------------------------------------------------

DA_LDT		 EQU	82h	    ; 局部描述符表段(LDT)
DA_TaskGate	 EQU	85h	    ; 任务门
DA_386TSS	 EQU	89h	    ; 可用 386 任务状态段(TSS)
DA_386CGate	 EQU	8Ch	    ; 386 调用门
DA_386IGate	 EQU	8Eh	    ; 386 中断门
DA_386TGate	 EQU	8Fh	    ; 386 陷阱门

;----------------------------------------------------------------------------


;----------------------------------------------------------------------------
; 选择子图示:
;         ┏━━━━┳━━━━┳━━━━┳━━━━┳━━━━┳━━━━┳━━━┳━━━┳━━━┳━━━┳━━━┳━━━┳━━━┳━━━┳━━━┳━━━┓
;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9 ┃ 8 ┃ 7 ┃ 6 ┃ 5 ┃ 4 ┃ 3 ┃ 2 ┃ 1 ┃ 0 ┃
;         ┣━━━━┻━━━━┻━━━━┻━━━━┻━━━━┻━━━━┻━━━┻━━━┻━━━┻━━━┻━━━┻━━━┻━━━╋━━━╋━━━┻━━━┫
;         ┃                  描述符offset                            ┃ TI┃  RPL  ┃
;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━┻━━━━━━━┛
;
; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
;
;   TI(Table Indicator): 引用描述符表指示位
;	TI=0 指示从全局描述符表GDT中读取描述符；
;	TI=1 指示从局部描述符表LDT中读取描述符。
;
;----------------------------------------------------------------------------
;----------------------------------------------------------------------------
; 选择子类型值说明
; 其中:
;       SA_  : Selector Attribute

SA_RPL0		EQU	0	; ┓
SA_RPL1		EQU	1	; ┣ RPL
SA_RPL2		EQU	2	; ┃
SA_RPL3		EQU	3	; ┛

SA_TIG		EQU	0	; ┓TI
SA_TIL		EQU	4	; ┛
;----------------------------------------------------------------------------


;----------------------------------------------------------------------------
; 分页机制使用的常量说明
;----------------------------------------------------------------------------

; PDE和PTE的第0位 P=0:不存在 P=1:存在
PG_P		EQU	1	; 页存在属性位               

; PDE和PTE的第1位 RW=0:只读 RW=1:读写
PG_RWR		EQU	0	; R/W 属性位值, 读/执行
PG_RWW		EQU	2	; R/W 属性位值, 读/写/执行

; PDE和PTE的第2位 US=0:系统级(CPL=0,1,2) US=1:用户级(CPL=3)
PG_USS		EQU	0	; U/S 属性位值, 系统级       
PG_USU		EQU	4	; U/S 属性位值, 用户级
;----------------------------------------------------------------------------


; 宏 ------------------------------------------------------------------------------
;
; 描述符
; 3个参数
;     1. 段基址: 传入参数为dword，使用32bit(4byte)
;     2. 段界限: 传入参数为dword，只使用低20bit
;     3. 属性:   传入参数为word，只使用了12bit，其中高字节的低4位总是0
%macro Descriptor 3     ; 3个参数
		dw    %2 & 0FFFFh        ; 段界限1，用参数2的低16位填充一个WORD (2 字节)
		dw    %1 & 0FFFFh        ; 段基址1，用参数1的低16位填充一个WORD (2 字节)
		db    (%1 >> 16) & 0FFh  ; 段基址2，用参数1的17-25位填充一个BYTE (1 字节)
		dw    ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)   ;
		db    (%1 >> 24) & 0FFh  ; 段基址3，用参数1的25-32位填充一个BYTE (1 字节)
%endmacro     ; 共 8 字节


; 宏 ------------------------------------------------------------------------------
;
; 门
; 4个参数
;     1. 选择子: 传入参数为word，使用16bit(2byte)
;     2. 偏移量: 传入参数为dword，使用32bit(4byte)
;     3. DCount: 传入参数为byte，只使用低5bit
;     4. 属性: 传入参数为byte，使用8bit(1byte)
%macro Gate 4
	dw    %2 & 0FFFFh        ; 偏移量1，用参数2的低16位填充一个WORD (2 字节)
	dw    %1                 ; 选择子，用参数1的填充一个WORD (2 字节)
	db    %3 & 01Fh          ; 写入DCount
	db    %4 & 0FFh          ; 属性
	dw    (%2 >> 16) & 0FFh  ; 偏移量2，用参数2的高16位填充一个WORD (2 字节)
%endmacro ; 共 8 字节

